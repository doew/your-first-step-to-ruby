---
marp: true
---
<!--
headingDivider: 3
-->

# 4 実践プログラミング

## この章では・・・
参考資料の提示と、追加の演習について考える。

## Appendix
ここまでの読み進めたが、未だによく状況がつかめない場合、以下の資料が役に立つ。YFStRは、 @doew が解説とともに提供する事を前提にしているのに対し、以下は自己学習を目的としているので、自己学習においては以下のサイトの方が役に立つだろう。

- TryRuby https://try.ruby-lang.org/
Rubyを解説と実際のコードとを相互参照しつつ、動かしながら体験できるサイト。
- 20分ではじめるRuby https://www.ruby-lang.org/ja/documentation/quickstart/
YFStRと同じような実際にコードを見ながら言語仕様を解説してくスタイルのドキュメント。IRBを使うようにしてあるので、YFStRよりも実際の入力画面に近い形で記述されている。


## Webサーバーを作る
簡単なWebサーバーを作ってみよう。ここでは、Step by Stepで一緒にコーディングしていくことを想定している。

#### 要件（最終的に目指すもの。今回はいきなり実装する必要は無い）
- Webサーバーを構築すること
- Webサーバーはroot path でアクセスしたユーザーのブラウザユーザーエージェントを確認できるHTMLを応答すること

### ライブラリのインストール
まずは、以下をコンソールで入力する。
```sh
# shell で実行する。
gem install sinatra
gem install thin
```
`gem` は ruby の標準ライブラリマネージャで、 `gem install` の後にパッケージ名を並べると外部(拡張)ライブラリを導入できる。これから作るwebサーバーのコードはこれら `sinatra` と `thin` に depend(依存)しているといえる。

### ライブラリの require(ロード)
適当な場所に `app.rb` を作成し、エディタで下の様にsinatra をロードする。

```rb
# app.rb
require 'sinatra'
```

なんと、これだけで webサーバーが完成する。 http://localhost:4567/ にアクセスして `Sinatra doesn't know this ditty.` が表示されるか確認する。 

<center>
<img src="./sinatra-def.png" width="300">
</center>

### ルーティング
すでに、 http://localhost:4567/ にWebサーバーは立っているが、このままではデフォルトの画面を出すだけになってしまう。
そこで、ルーティングを設定し、あるpathにアクセスされたときの挙動を設定してみよう。

```rb
# app.rb
require 'sinatra'

get '/' do
  "Hello World"
end
```
こうすると、http://localhost:4567 にアクセスした際にデフォルトの画面ではなく、 `Hello World` と表示されるようになる。
*このような一見特殊な記述で振る舞いを定義できるものをDSLということがある

### view ファイルを分離する
今のままだと、ルーティングファイルに全ての画面の中身を記述しなければならず、現実的でないので、 view ファイルを分割してみよう。

新規に `view` ディレクトリを作成し、その中に `index.erb` というファイルを作成する。

```html
<!-- view/index.erb -->
Hello World
```

そして、ルーティングではそのファイルを呼び出すようにする。
（とりあえず今のところは呪文の認識でよい。書き換えたらアクセスしてみる。）

```rb
# app.rb
require 'sinatra'

get '/' do
  erb :index
end
```

### 動的なWebサイト
普段、我々が見ているWebサイトは静的なものと動的なものがある。静的なWebサイトでは、ただ単にWebサーバーにHTMLを配置すれば良いが（いまコーディングしている状況がそれ）、動的にしようと思うとHTML内で変数を適当に展開する必要がある。

```rb
# app.rb
require 'sinatra'

get '/' do
  @request = request
  erb :index
end
```
erb ファイルには以下の様に記述して、動作を確認してみよう。
```html
<!-- view/index.erb -->
Your User Agent is... <BR>
<%= @request.user_agent %>
```

### ERBレンダリングエンジン
ERBはスクリプトなどの文書をRubyを埋め込んで動的に生成できるようにする仕組みで、 `.erb` の拡張子を設定する。

`<% [ruby code] %>` でRubyのコードを記述でき、 `<%= [ruby code]%>` を記述すると、文を評価した値をその場に埋め込む。

今回はHTMLに対して埋め込みを展開したが、あらゆる文書で利用できる。

### Webサーバーを工夫して様々な情報を表示する
`net/http` や `rss` を利用したりするなどすると、より幅広い動的なサーバーを構築できる。
例えば、他のWebサーバーから取得した情報をカスタマイズして表示したり、更新内容をRSS Feedにしたりできる。

また、Webサーバーの中には、スーパーグローバル（スレッドによらないスコープ）の変数を格納したいアプリケーションを動かす事がある。そういった場合は、RDBやNoSQLといったDBに情報を蓄積・読み出しするなどして、データを賢く扱っていく。

このように処理が多くなってくると、Webサーバーは適宜処理をかき分ける必要が出てくるようになる。今回はViewだけ分けたが、MVCモデルなど、ファイルの分割手法は複数存在している。なお、Webサーバーだけによらず、クライアントアプリケーション（モバイルアプリなど）もこのようなソフトウェア設計パラダイムを持つことが多い。

## まとめ
今回は、Webサーバーを構築する Ruby プログラムを作成した。このように、Rubyでは様々なプログラムを書くことができる。簡潔にソースコードを保つために、外部ライブラリがよく働いていることも理解出来たと思う。

## 5章の予告
5章では、外部ライブラリ(`gem`)を自作してみる。
